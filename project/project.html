<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title> Project!!! </title>
    <link rel="stylesheet" href="css/leaflet.css"/>
    <link rel="stylesheet" href="css/style.css"/>
</head>
<body>
	<script type="text/javascript" src="javascript/util/d3.v3.js"></script>
	<script type="text/javascript" src="javascript/util/d3-tip.js"></script>
	<script type="text/javascript" src="javascript/util/topojson.v1.js"></script>
	<script type="text/javascript" src="javascript/util/leaflet.js"></script>
	<script type="text/javascript" src="javascript/util/queue.v1.js"></script>
	<script type="text/javascript" src="javascript/projectpreproc.js"></script>
	<script type="text/javascript" src="javascript/projectvisual.js"></script>
	<script>
	

	var mapsvg = d3.select("body").append("svg")
		//.attr("x", 0)
		//.attr("y", 0)
		.attr("width", 500)
		.attr("height", 300);
	/*
	var infosvg = d3.select("body").append("svg")
			//.attr("x", 0)
			//.attr("y", 300)
			.attr("width", 700)
			.attr("height", 200);	
*/
	
	var comparisonsvg = d3.select("body").append("svg")
		//.attr("x", 550)
		//.attr("y", 5)
		.attr("width", 180)
		.attr("height", 500);
	
	
	//call function to load the data)
	loadData();
	function ready(error, mapData, hospitalData, zipCodeData) {	
		if (error) throw error;

		var hospitalIDs = [];
		
		var hospitals = {};
		
		createHospitalObject(hospitalData, hospitals, hospitalIDs);
		
		
		console.log(hospitalIDs);
		addDRGdata(hospitals, hospitalData);
		
		console.log("after calling addDRGdata we have");
		console.log(hospitals);
		
		//call this function and the hospitals will be plotted on the map, but it is slow so its not necessary when testing
		//addHospitalCoordinates(zipCodeData, hospitals, hospitalIDs);
		
		console.log("after calling addHospitalCoordinates we have");
		console.log(hospitals);
		
		createLayout(mapData, hospitals, hospitalIDs);
		
		//everything below here is just testing
		
		//hospitals and DRGs used for testing
		var hospitalChoices = [10001, 10055];
		var DRGchoices = [39, 303, 312];
		
		console.log("WÖÖÖÖÖÖÖÖÖÖÖÖÖ");
		console.log(+parseInt(hospitalData[8]['DRG Definition'], 10));
		console.log(hospitalData[8]['DRG Definition']);
		console.log(+DRGchoices[2]);
		
		var DRGnames = [];
		for (i = 0; i < DRGchoices.length; i++) {
			for (j = 0; j < hospitalData.length; j++) {
				if (+parseInt(hospitalData[j]['DRG Definition'], 10) == +DRGchoices[i]) {
					console.log(hospitalData[j]['DRG Definition']);
					DRGnames.push(hospitalData[j]['DRG Definition']);
					break;
				}
			}
		}
		
		console.log("testing below");
	
		//add new SVGs to the right panel. 
		//providersvg displays the chosen providers
		//DRGsvg shows the chosen DRGs
		var providerssvg = comparisonsvg.append("svg").attr("width", 180).attr("height", 100);
		var DRGsvg = comparisonsvg.append("svg").attr("width", 180).attr("height", 400).attr("y", 100);
		
		providerssvg.append("rect").attr("fill", "blue").style("opacity", 0.5).attr("height", 10).attr("width", 180).attr("y", 30);
		DRGsvg.append("rect").attr("fill", "blue").style("opacity", 0.5).attr("height", 10).attr("width", 180);
		
		providerssvg.append('text').text('Uncovered Charges Comparison')
                .attr('x', 5)
                .attr('y', 15)
                .attr('fill', 'black')
				.attr("font-family", "sans-serif")
				.style("font-weight","bold")
                .attr("font-size", "9px");
				
		providerssvg.append('text').text('Providers')
                .attr('x', 5)
                .attr('y', 38)
                .attr('fill', 'black')
				.attr("font-family", "sans-serif")
                .attr("font-size", "9px");
				
		DRGsvg.append('text').text('Diagnostic - related groups')
                .attr('x', 5)
                .attr('y', 7)
                .attr('fill', 'black')
				.attr("font-family", "sans-serif")
                .attr("font-size", "9px");
				
		providerssvg.selectAll("listtext")
			.data(hospitalChoices)
			.enter()
				.append("text")
				.attr("class", "listtext")
				.attr("y", function(d, i) {
					return 50 + i * 15;
				})
				.attr("x", 6)
				.attr("font-family", "sans-serif")
                .attr("font-size", "8px")
				.text(function(d) {
					return hospitals[d].name;
				});
		
		DRGsvg.selectAll("listtext")
			.data(DRGchoices)
			.enter()
				.append("text")
				.attr("class", "listtext")
				.attr("y", function(d, i) {
					return 30 + i * 15;
				})
				.attr("x", 6)
				.attr("font-family", "sans-serif")
                .attr("font-size", "10px")
				.text(function(d, i) {
					return DRGnames[i];
				});
							
		
		//create one SVG for each chosen DRG and append it to DRGsvg
		for (i = 0; i < DRGchoices.length; i++) {
			//create a variable that will be used to give an ID to the SVG representing a DRG
			var variablename = "DRGchoice" + [i];
			console.log(variablename);
			DRGsvg.append("svg").attr("height", 100).attr("width", 180).attr("y", DRGchoices.length * 20 + i*100).attr("id", variablename);
			
			d3.select("#" + variablename).append("text")
				.attr("class", "listtext")
				.attr("y", 20)
				.attr("x", 70)
				.attr("font-family", "sans-serif")
                .attr("font-size", "15px")
				.text(DRGchoices[i]);
				
			//find the maximum cost of the DRG at the different hospitals that have been chosen
			var maxcost = 0;
			for (j = 0; j < hospitalChoices.length; j++) {
				console.log("hello");
				console.log(hospitals[10001].DRGs);
				console.log(hospitals[hospitalChoices[j]].DRGs[DRGchoices[i]]);
				if (hospitals[hospitalChoices[j]].DRGs[DRGchoices[i]].avgCC > maxcost) {
					console.log("new maxcost is " + hospitals[hospitalChoices[j]].DRGs[DRGchoices[i]].avgCC);
					maxcost = +hospitals[hospitalChoices[j]].DRGs[DRGchoices[i]].avgCC;
				}
			}
			
			//create scale so that we can give the rectangles a width depending on the relative costs
			var widthScale = d3.scale.linear()
								.domain([0, maxcost])
								.range([0, 150]);
					
			d3.select("#" + variablename).selectAll("rect")
				.data(hospitalChoices)
				.enter()
					.append("rect")
					.attr("drg", DRGchoices[i])
					.attr("height", 10).attr("width", function (d) {return widthScale(hospitals[d].DRGs[DRGchoices[i]].avgCC); }).attr("x", 30).attr("y", function (d,i) {return 30 + i * 15;})
					.on("click", clicked);
					
			d3.select("#" + variablename).selectAll("listtext")
				.data(hospitalChoices)
				.enter()
					.append("text")
					.attr("class", "listtext")
					.attr("y", function(d, i) {
						return 38 + i * 15;
					})
					.attr("x", 6)
					.attr("font-family", "sans-serif")
					.attr("font-size", "6px")
					.text(function(d) {
						console.log(d); return d;
					});
		
		}
		
		//click a rectangle to get some information about the data it represents. will be replaced by a tooltip later(?)
		function clicked(e) {
			console.log("total cost of DRG " + d3.select(this).attr("drg") + " at " + hospitals[e].name + " is " + hospitals[e].DRGs[d3.select(this).attr("drg")].avgCC);
		}
		
	}	
	</script>
	</body>
</html>